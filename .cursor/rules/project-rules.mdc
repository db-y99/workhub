---
alwaysApply: true
---
## ğŸ“Œ PATH ALIASES

Dá»± Ã¡n sá»­ dá»¥ng path alias `@/*` trá» vá» root directory (Ä‘Ã£ cáº¥u hÃ¬nh trong `tsconfig.json`):

```typescript
// tsconfig.json
{
  "paths": {
    "@/*": ["./*"]
  }
}
```

**CÃ¡ch import:**
```typescript
// âœ… ÄÃšNG
import { ROUTES } from '@/constants/routes';
import { supabaseClient } from '@/lib/supabase/client';
import { User } from '@/services/users/users.types';
import { Navbar } from '@/components/navbar';
import { siteConfig } from '@/config/site';

// âŒ SAI - KhÃ´ng dÃ¹ng relative paths dÃ i
import { ROUTES } from '../../../constants/routes';
```

---

## 1ï¸âƒ£ CONSTANTS â€“ ROUTES (KHÃ”NG HARD CODE)

**File:** `constants/routes.ts`

```typescript
export const ROUTES = {
  // Public routes
  HOME: '/',
  LOGIN: '/login',
  SIGNUP: '/signup',
  ABOUT: '/about',
  BLOG: '/blog',
  DOCS: '/docs',
  PRICING: '/pricing',
  
  // Protected routes (cáº§n Ä‘Äƒng nháº­p)
  DASHBOARD: '/dashboard',
  USERS: '/dashboard/users',
  PROFILE: '/dashboard/profile',
  SETTINGS: '/dashboard/settings',
  
  // Auth routes (khÃ´ng Ä‘Æ°á»£c vÃ o náº¿u Ä‘Ã£ login)
  AUTH_CALLBACK: '/auth/callback',
} as const;

// Route groups for middleware protection
export const PUBLIC_ROUTES = [
  ROUTES.HOME,
  ROUTES.LOGIN,
  ROUTES.SIGNUP,
  ROUTES.ABOUT,
  ROUTES.BLOG,
  ROUTES.DOCS,
  ROUTES.PRICING,
] as const;

export const PROTECTED_ROUTES = [
  ROUTES.DASHBOARD,
  ROUTES.USERS,
  ROUTES.PROFILE,
  ROUTES.SETTINGS,
] as const;

export const AUTH_ROUTES = [
  ROUTES.LOGIN,
  ROUTES.SIGNUP,
  ROUTES.AUTH_CALLBACK,
] as const;
```

**Rule:** 
- Táº¥t cáº£ routes pháº£i Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong file nÃ y, khÃ´ng Ä‘Æ°á»£c hardcode trong code
- Äá»‹nh nghÄ©a route groups (`PUBLIC_ROUTES`, `PROTECTED_ROUTES`, `AUTH_ROUTES`) Ä‘á»ƒ dÃ¹ng trong middleware

**âš ï¸ LÆ°u Ã½ quan trá»ng:**
- âœ… **Táº¥t cáº£ giÃ¡ trá»‹ cÃ³ cáº¥u trÃºc** (roles, permissions, status, enum values) â†’ **PHáº¢I dÃ¹ng constants**
- âœ… KhÃ´ng hardcode string literals nhÆ° `'admin'`, `'active'`, `'pending'`, etc.
- âœ… DÃ¹ng `as const` Ä‘á»ƒ type safety
- âœ… Export types tá»« constants Ä‘á»ƒ reuse

**VÃ­ dá»¥ cÃ¡c giÃ¡ trá»‹ cáº§n constants:**
- Roles: `ROLES.ADMIN`, `ROLES.USER` (khÃ´ng dÃ¹ng `'admin'`, `'user'`)
- Status: `STATUS.ACTIVE`, `STATUS.PENDING` (khÃ´ng dÃ¹ng `'active'`, `'pending'`)
- Permissions: `PERMISSIONS.CREATE_USER` (khÃ´ng dÃ¹ng `'create_user'`)
- Error codes: `ERROR_CODES.NOT_FOUND` (khÃ´ng dÃ¹ng `'NOT_FOUND'`)

---

## 1ï¸âƒ£1ï¸âƒ£ ENV & CONFIG â€“ KHÃ”NG ÄÆ¯á»¢C process.env Ráº¢I RÃC

**ğŸ”’ RULE Cá»¨NG:**
- âŒ **KHÃ”NG dÃ¹ng `process.env.XYZ` trá»±c tiáº¿p** ngoÃ i `config/`
- âœ… **Báº®T BUá»˜C wrap qua config + Zod validation**

**LÃ½ do:**
- TrÃ¡nh crash production vÃ¬ thiáº¿u env variables
- Type-safe env access vá»›i Zod validation
- Centralized config management
- Fail fast khi env invalid (build time hoáº·c startup)

**Cáº¥u trÃºc:**
```typescript
// config/env.ts
import { z } from 'zod';

const EnvSchema = z.object({
  // Public env (exposed to client)
  NEXT_PUBLIC_SUPABASE_URL: z.string().url('Invalid Supabase URL'),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1, 'Supabase anon key is required'),
  
  // Server-only env (khÃ´ng expose cho client)
  DATABASE_URL: z.string().url('Invalid database URL').optional(),
  SECRET_KEY: z.string().min(1, 'Secret key is required').optional(),
});

// Parse vÃ  validate env táº¡i build/startup time
export const env = EnvSchema.parse({
  NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
  NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
  DATABASE_URL: process.env.DATABASE_URL,
  SECRET_KEY: process.env.SECRET_KEY,
});
```

**VÃ­ dá»¥ sá»­ dá»¥ng:**
```typescript
// âœ… ÄÃšNG - DÃ¹ng env tá»« config
// lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr';
import { env } from '@/config/env';

export const supabaseClient = createBrowserClient(
  env.NEXT_PUBLIC_SUPABASE_URL,
  env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);

// âœ… ÄÃšNG - Server client
// lib/supabase/server.ts
import { cookies } from 'next/headers';
import { createServerClient } from '@supabase/ssr';
import { env } from '@/config/env';

export const createSupabaseServerClient = () => {
  const cookieStore = cookies();

  return createServerClient(
    env.NEXT_PUBLIC_SUPABASE_URL,
    env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
    {
      cookies: {
        get(name) {
          return cookieStore.get(name)?.value;
        },
      },
    }
  );
};

// âŒ SAI - DÃ¹ng process.env trá»±c tiáº¿p
export const supabaseClient = createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!, // âŒ KHÃ”NG Ä‘Æ°á»£c dÃ¹ng
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY! // âŒ
);
```

**Rule:**
- âœ… **Táº¥t cáº£ env variables** pháº£i Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong `config/env.ts`
- âœ… **Zod validation** Ä‘á»ƒ Ä‘áº£m báº£o env há»£p lá»‡
- âœ… **Import tá»« `@/config/env`** khi cáº§n dÃ¹ng env
- âŒ **KHÃ”NG dÃ¹ng `process.env`** trá»±c tiáº¿p trong code (trá»« `config/env.ts`)
- âœ… **Type-safe** vá»›i Zod schema â†’ TypeScript tá»± Ä‘á»™ng infer type

---

## 2ï¸âƒ£ SUPABASE CLIENT (CLIENT SIDE)

**File:** `lib/supabase/client.ts`

```typescript
import { createBrowserClient } from '@supabase/ssr';
import { env } from '@/config/env';

export const supabaseClient = createBrowserClient(
  env.NEXT_PUBLIC_SUPABASE_URL,
  env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);
```

**Rule:** Chá»‰ dÃ¹ng cho Client Components, hooks, vÃ  client-side services.

---

## 3ï¸âƒ£ SUPABASE SERVER CLIENT

**File:** `lib/supabase/server.ts`

```typescript
import { cookies } from 'next/headers';
import { createServerClient } from '@supabase/ssr';
import { env } from '@/config/env';

export const createSupabaseServerClient = () => {
  const cookieStore = cookies();

  return createServerClient(
    env.NEXT_PUBLIC_SUPABASE_URL,
    env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
    {
      cookies: {
        get(name) {
          return cookieStore.get(name)?.value;
        },
      },
    }
  );
};
```

**Rule:** Chá»‰ dÃ¹ng trong Server Components, Server Actions, vÃ  server-side services.

---

## 4ï¸âƒ£ SUPABASE MIDDLEWARE

**File:** `lib/supabase/middleware.ts`

```typescript
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { createServerClient } from '@supabase/ssr';
import { ROUTES } from '@/constants/routes';
import { env } from '@/config/env';

export const updateSession = (request: NextRequest) => {
  let response = NextResponse.next({ request });

  const supabase = createServerClient(
    env.NEXT_PUBLIC_SUPABASE_URL,
    env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
    {
      cookies: {
        get: (name) => request.cookies.get(name)?.value,
        set: (name, value, options) => {
          response.cookies.set({ name, value, ...options });
        },
        remove: (name, options) => {
          response.cookies.set({ name, value: '', ...options });
        },
      },
    }
  );

  return { supabase, response };
};
```

**Rule:** DÃ¹ng trong `app/middleware.ts` Ä‘á»ƒ xá»­ lÃ½ session vÃ  authentication.

**âš ï¸ LÆ°u Ã½:** Háº¡n cháº¿ sá»­ dá»¥ng `getSession()` theo khuyáº¿n nghá»‹ cá»§a Supabase docs. Thay vÃ o Ä‘Ã³, dÃ¹ng `getUser()` Ä‘á»ƒ check authentication.

---

## 4ï¸âƒ£1ï¸âƒ£ ROUTE PROTECTION & AUTH GUARDS

### Protected vÃ  Public Routes

**File:** `constants/routes.ts` (cáº­p nháº­t)

```typescript
export const ROUTES = {
  // Public routes
  HOME: '/',
  LOGIN: '/login',
  SIGNUP: '/signup',
  ABOUT: '/about',
  BLOG: '/blog',
  DOCS: '/docs',
  PRICING: '/pricing',
  
  // Protected routes (cáº§n Ä‘Äƒng nháº­p)
  DASHBOARD: '/dashboard',
  USERS: '/dashboard/users',
  PROFILE: '/dashboard/profile',
  SETTINGS: '/dashboard/settings',
  
  // Auth routes (khÃ´ng Ä‘Æ°á»£c vÃ o náº¿u Ä‘Ã£ login)
  AUTH_CALLBACK: '/auth/callback',
} as const;

// Route groups
export const PUBLIC_ROUTES = [
  ROUTES.HOME,
  ROUTES.LOGIN,
  ROUTES.SIGNUP,
  ROUTES.ABOUT,
  ROUTES.BLOG,
  ROUTES.DOCS,
  ROUTES.PRICING,
] as const;

export const PROTECTED_ROUTES = [
  ROUTES.DASHBOARD,
  ROUTES.USERS,
  ROUTES.PROFILE,
  ROUTES.SETTINGS,
] as const;

export const AUTH_ROUTES = [
  ROUTES.LOGIN,
  ROUTES.SIGNUP,
  ROUTES.AUTH_CALLBACK,
] as const;
```

---

### Middleware vá»›i Route Protection

**File:** `app/middleware.ts`

```typescript
import { NextResponse, type NextRequest } from 'next/server';
import { updateSession } from '@/lib/supabase/middleware';
import { ROUTES, PUBLIC_ROUTES, PROTECTED_ROUTES, AUTH_ROUTES } from '@/constants/routes';

export async function middleware(request: NextRequest) {
  const { supabase, response } = updateSession(request);
  const { pathname } = request.nextUrl;

  // Check authentication - dÃ¹ng getUser() thay vÃ¬ getSession()
  const {
    data: { user },
  } = await supabase.auth.getUser();

  const isAuthenticated = !!user;
  
  // Type-safe route checking - khÃ´ng dÃ¹ng any
  // âš ï¸ LÆ°u Ã½: HOME ('/') lÃ  special-case vá»›i startsWith()
  // - Náº¿u chá»‰ dÃ¹ng startsWith('/'), sáº½ match má»i route (khÃ´ng mong muá»‘n)
  // - Logic hiá»‡n táº¡i: check exact match (pathname === route) TRÆ¯á»šC startsWith()
  // - Vá»›i route = '/': pathname === '/' â†’ match exact, khÃ´ng cáº§n startsWith()
  // - Vá»›i route khÃ¡c: pathname === '/dashboard' || pathname.startsWith('/dashboard/') â†’ match exact + nested
  const isPublicRoute = PUBLIC_ROUTES.some(
    (route) => pathname === route || pathname.startsWith(`${route}/`)
  );
  const isProtectedRoute = PROTECTED_ROUTES.some(
    (route) => pathname === route || pathname.startsWith(`${route}/`)
  );
  const isAuthRoute = AUTH_ROUTES.some(
    (route) => pathname === route || pathname.startsWith(`${route}/`)
  );

  // Rule 1: Náº¿u Ä‘Ã£ login â†’ khÃ´ng Ä‘Æ°á»£c vÃ o auth routes â†’ redirect vá» dashboard
  if (isAuthenticated && isAuthRoute) {
    return NextResponse.redirect(new URL(ROUTES.DASHBOARD, request.url));
  }

  // Rule 2: Náº¿u chÆ°a login â†’ khÃ´ng Ä‘Æ°á»£c vÃ o protected routes â†’ redirect vá» login
  if (!isAuthenticated && isProtectedRoute) {
    const redirectUrl = new URL(ROUTES.LOGIN, request.url);
    redirectUrl.searchParams.set('redirect', pathname);
    return NextResponse.redirect(redirectUrl);
  }

  return response;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes - tá»± guard báº±ng server logic)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public folder
     */
    '/((?!api|_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
```

**Rules:**
- âœ… DÃ¹ng `getUser()` thay vÃ¬ `getSession()` (theo Supabase docs)
- âœ… Náº¿u Ä‘Ã£ login â†’ redirect khá»i auth routes vá» dashboard
- âœ… Náº¿u chÆ°a login â†’ redirect khá»i protected routes vá» login
- âœ… Public routes luÃ´n accessible
- âœ… LÆ°u redirect URL Ä‘á»ƒ quay láº¡i sau khi login
- âœ… Type-safe route checking (khÃ´ng dÃ¹ng `any`)
- âœ… Handle nested routes tá»‘t hÆ¡n vá»›i `startsWith()`
- âœ… **Loáº¡i trá»« `/api` routes** - API tá»± guard báº±ng server logic, khÃ´ng cáº§n middleware
- âœ… **CHá»ˆ check authentication** - KhÃ´ng check role/permission trong middleware

---

### Auth Guard Helper

**File:** `lib/auth/guards.ts`

```typescript
import { createSupabaseServerClient } from '@/lib/supabase/server';
import { ROUTES } from '@/constants/routes';
import { redirect } from 'next/navigation';

/**
 * Server-side auth guard
 * Redirect náº¿u chÆ°a Ä‘Äƒng nháº­p
 * @returns User object náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p
 */
export const requireAuth = async () => {
  const supabase = createSupabaseServerClient();
  
  // DÃ¹ng getUser() thay vÃ¬ getSession()
  const {
    data: { user },
    error,
  } = await supabase.auth.getUser();

  if (error || !user) {
    redirect(ROUTES.LOGIN);
  }

  return user;
};

/**
 * Server-side auth guard vá»›i redirect path
 * @param redirectTo - Path Ä‘á»ƒ redirect sau khi login
 * @returns User object náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p
 */
export const requireAuthWithRedirect = async (redirectTo: string) => {
  const supabase = createSupabaseServerClient();
  
  const {
    data: { user },
    error,
  } = await supabase.auth.getUser();

  if (error || !user) {
    // âœ… DÃ¹ng relative URL - redirect() lÃ  server-only, khÃ´ng cáº§n absolute URL
    redirect(`${ROUTES.LOGIN}?redirect=${encodeURIComponent(redirectTo)}`);
  }

  return user;
};

/**
 * Check náº¿u user Ä‘Ã£ Ä‘Äƒng nháº­p (khÃ´ng redirect)
 * @returns User object hoáº·c null
 */
export const getCurrentUser = async () => {
  const supabase = createSupabaseServerClient();
  
  const {
    data: { user },
  } = await supabase.auth.getUser();

  return user;
};

/**
 * Redirect náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p (dÃ¹ng cho auth pages)
 */
export const redirectIfAuthenticated = async () => {
  const supabase = createSupabaseServerClient();
  
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (user) {
    redirect(ROUTES.DASHBOARD);
  }
};
```

**Usage trong Server Components:**

```typescript
// âœ… ÄÃšNG - Protected page (Middleware Ä‘Ã£ handle, khÃ´ng cáº§n guard náº¿u chá»‰ cáº§n check auth)
// app/(dashboard)/users/page.tsx
import { getUsersService } from '@/services/users/users.service';
import UsersTable from '@/components/users-table.client';

const UsersPage = async () => {
  // Middleware Ä‘Ã£ redirect náº¿u chÆ°a login, khÃ´ng cáº§n requireAuth() ná»¯a
  const users = await getUsersService();

  return <UsersTable users={users} />;
};

export default UsersPage;

// âœ… ÄÃšNG - Protected page (Cáº§n user object trong page)
// app/(dashboard)/profile/page.tsx
import { requireAuth } from '@/lib/auth/guards';
import { getUserProfileService } from '@/services/users/users.service';

const ProfilePage = async () => {
  // Cáº§n user object â†’ dÃ¹ng requireAuth() Ä‘á»ƒ láº¥y user
  const user = await requireAuth();
  const profile = await getUserProfileService(user.id);

  return <ProfileForm user={user} profile={profile} />;
};

// âœ… ÄÃšNG - Auth page (Middleware Ä‘Ã£ handle, khÃ´ng cáº§n guard)
// app/(auth)/login/page.tsx
import LoginForm from '@/components/login-form.client';

const LoginPage = async () => {
  // Middleware Ä‘Ã£ redirect náº¿u Ä‘Ã£ login, khÃ´ng cáº§n redirectIfAuthenticated() ná»¯a
  return <LoginForm />;
};

export default LoginPage;

// âœ… ÄÃšNG - Check user khÃ´ng redirect (cáº§n user data)
// app/page.tsx
import { getCurrentUser } from '@/lib/auth/guards';

const HomePage = async () => {
  // Cáº§n user data Ä‘á»ƒ render conditional content
  const user = await getCurrentUser();

  return (
    <div>
      {user ? (
        <div>Welcome back, {user.email}</div>
      ) : (
        <div>Welcome, please login</div>
      )}
    </div>
  );
};

export default HomePage;
```

**Khi nÃ o cáº§n dÃ¹ng Guards:**
- âœ… **Cáº§n user object** trong page â†’ dÃ¹ng `requireAuth()` hoáº·c `getCurrentUser()`
- âœ… **Logic phá»©c táº¡p** â†’ cáº§n check role, permissions, etc.
- âŒ **Chá»‰ cáº§n check auth** â†’ Middleware Ä‘Ã£ handle, khÃ´ng cáº§n guard

**Khi nÃ o KHÃ”NG cáº§n Guards:**
- âŒ Middleware Ä‘Ã£ handle route protection Ä‘áº§y Ä‘á»§
- âŒ Chá»‰ cáº§n check authenticated/not authenticated (khÃ´ng cáº§n user object)

---

### Client-side Auth Guard Hook

**File:** `hooks/use-require-auth.ts`

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { supabaseClient } from '@/lib/supabase/client';
import { ROUTES } from '@/constants/routes';
import type { User } from '@supabase/supabase-js';

export const useRequireAuth = () => {
  const router = useRouter();
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const checkAuth = async () => {
      // DÃ¹ng getUser() thay vÃ¬ getSession()
      const { data } = await supabaseClient.auth.getUser();

      if (!data.user) {
        setIsLoading(false); // âœ… FIX: Set loading false trÆ°á»›c khi redirect
        router.replace(ROUTES.LOGIN);
        return;
      }

      setUser(data.user);
      setIsLoading(false);
    };

    checkAuth();
    // âœ… KhÃ´ng cáº§n onAuthStateChange - Middleware Ä‘Ã£ handle route protection
    // Hook chá»‰ dÃ¹ng cho widget/modal, getUser() lÃ  Ä‘á»§
  }, [router]);

  return { user, isLoading };
};
```

**âš ï¸ LÆ°u Ã½ quan trá»ng:**
- âœ… Set `isLoading(false)` trÆ°á»›c khi redirect Ä‘á»ƒ trÃ¡nh káº¹t loading
- âœ… KhÃ´ng cáº§n `onAuthStateChange` - Middleware Ä‘Ã£ handle route protection
- âœ… DÃ¹ng `router.replace()` thay vÃ¬ `router.push()` Ä‘á»ƒ khÃ´ng táº¡o history entry
- âœ… Hook chá»‰ dÃ¹ng cho widget/modal, khÃ´ng dÃ¹ng cho page-level protection

**âš ï¸ QUAN TRá»ŒNG: Khi nÃ o dÃ¹ng `useRequireAuth()`**

â— **KHÃ”NG dÃ¹ng cho page-level protection** - Middleware Ä‘Ã£ handle rá»“i!

âœ… **CHá»ˆ dÃ¹ng cho:**
- Modal cáº§n user object
- Client-only widget (sidebar, dropdown, etc.)
- Component Ä‘á»™c láº­p cáº§n user object
- Component khÃ´ng pháº£i page-level

âŒ **KHÃ”NG dÃ¹ng cho:**
- Protected pages (middleware Ä‘Ã£ handle)
- Auth pages (middleware Ä‘Ã£ handle)
- Page-level components

**Usage trong Client Components:**

```typescript
// âœ… ÄÃšNG - Modal cáº§n user object
'use client';

import { useRequireAuth } from '@/hooks/use-require-auth';

const UserSettingsModal = () => {
  const { user, loading } = useRequireAuth();

  if (loading) {
    return <div>Loading...</div>;
  }

  if (!user) {
    return null; // Modal sáº½ khÃ´ng hiá»ƒn thá»‹ náº¿u chÆ°a login
  }

  return <div>Settings for {user.email}</div>;
};

// âœ… ÄÃšNG - Client-only widget
const UserDropdown = () => {
  const { user, loading } = useRequireAuth();

  if (loading || !user) {
    return null;
  }

  return <Dropdown user={user} />;
};

// âŒ SAI - Page-level component (middleware Ä‘Ã£ handle)
const ProtectedPage = () => {
  const { user, loading } = useRequireAuth(); // âŒ KHÃ”NG cáº§n
  // Middleware Ä‘Ã£ redirect náº¿u chÆ°a login
  return <div>Protected content</div>;
};
```

---

## âœ… RULES CHO AUTH & ROUTE PROTECTION

### âŒ KHÃ”NG ÄÆ¯á»¢C LÃ€M

1. âŒ **Sá»­ dá»¥ng `getSession()`**
   - KhÃ´ng dÃ¹ng `supabase.auth.getSession()` trong middleware hoáº·c server components
   - Pháº£i dÃ¹ng `getUser()` thay tháº¿ (theo Supabase docs)

2. âŒ **Hardcode route paths trong guards**
   - KhÃ´ng hardcode `/login`, `/dashboard` trong guards
   - Pháº£i dÃ¹ng `ROUTES` tá»« `@/constants/routes`

3. âŒ **DÃ¹ng `useRequireAuth()` cho page-level protection**
   - âŒ KHÃ”NG dÃ¹ng `useRequireAuth()` cho protected pages (middleware Ä‘Ã£ handle)
   - âŒ KHÃ”NG dÃ¹ng `useRequireAuth()` cho auth pages (middleware Ä‘Ã£ handle)
   - âŒ KHÃ”NG dÃ¹ng `useRequireAuth()` cho page-level components
   - âœ… CHá»ˆ dÃ¹ng `useRequireAuth()` cho: Modal, Client-only widget, Component Ä‘á»™c láº­p cáº§n user object

### âœ… PHáº¢I LÃ€M

1. âœ… **DÃ¹ng `getUser()` thay vÃ¬ `getSession()`**
   - Trong middleware: `await supabase.auth.getUser()`
   - Trong server components: `await supabase.auth.getUser()`
   - Trong client: `await supabaseClient.auth.getUser()`

2. âœ… **Middleware protection (Primary - Lá»›p báº£o vá»‡ chÃ­nh)**
   - Náº¿u Ä‘Ã£ login â†’ redirect khá»i auth routes
   - Náº¿u chÆ°a login â†’ redirect khá»i protected routes
   - Public routes luÃ´n accessible
   - **Middleware Ä‘Ã£ handle route protection Ä‘áº§y Ä‘á»§, khÃ´ng cáº§n guard trong page ná»¯a**

3. âœ… **Server-side guards (Optional - chá»‰ khi cáº§n)**
   - **KHÃ”NG cáº§n** guard náº¿u middleware Ä‘Ã£ handle route protection
   - **CHá»ˆ cáº§n** guard khi:
     - Cáº§n user object trong page â†’ dÃ¹ng `requireAuth()` hoáº·c `getCurrentUser()`
     - Cáº§n logic phá»©c táº¡p (role, permissions, etc.)
   - **KHÃ”NG cáº§n** `redirectIfAuthenticated()` trong auth pages vÃ¬ middleware Ä‘Ã£ handle

4. âœ… **Route constants**
   - Äá»‹nh nghÄ©a `PUBLIC_ROUTES`, `PROTECTED_ROUTES`, `AUTH_ROUTES` trong `constants/routes.ts`
   - DÃ¹ng constants thay vÃ¬ hardcode

5. âœ… **Role & Permission (Future)**
   - **Auth = Middleware** â†’ Handle authentication (Ä‘Ã£ login hay chÆ°a)
   - **Permission = Server Guard / Service** â†’ Handle authorization (role, permissions)
   - Permissions Ä‘Æ°á»£c check á»Ÿ server-side, khÃ´ng pháº£i middleware
   - DÃ¹ng guards trong pages/services Ä‘á»ƒ check permissions

**ğŸ”’ RULE Cá»¨NG - Auth vs Permission:**

1. **Middleware: CHá»ˆ check authentication (login hay chÆ°a)**
   - âœ… Check: User Ä‘Ã£ login hay chÆ°a
   - âŒ KHÃ”NG check: Role, Permission, Status
   - âŒ KHÃ”NG cÃ³ logic phá»©c táº¡p (trÃ¡nh edge crash)

2. **Permission: CHá»ˆ check á»Ÿ page (PermissionGuard)**
   - âœ… Check trong page vá»›i `<PermissionGuard requiredPermissions={[...]}>`
   - âŒ KHÃ”NG check permission trong API routes
   - âŒ KHÃ”NG check permission trong server actions
   - **LÃ½ do:** Page cÃ³ thá»ƒ gá»i nhiá»u API cá»§a cÃ¡c feature khÃ¡c; náº¿u API check permission sáº½ 403 dÃ¹ user Ä‘Ã£ vÃ o Ä‘Æ°á»£c page
   - **API routes & Server actions:** CHá»ˆ check auth (Ä‘Äƒng nháº­p), khÃ´ng check permission

3. **Táº¡i sao khÃ´ng check role trong middleware?**
   - Middleware cháº¡y á»Ÿ edge â†’ cÃ³ thá»ƒ crash vá»›i logic phá»©c táº¡p
   - Role/permission logic thÆ°á»ng cáº§n database query
   - Server guards/services cÃ³ Ä‘áº§y Ä‘á»§ context vÃ  error handling

**Rule:**
- **DÃ¹ng constants cho roles, permissions, status, etc.** â†’ TrÃ¡nh typo vÃ  dá»… maintain
- **TÃ¡ch biá»‡t rÃµ rÃ ng:** Auth (middleware) vs Permission (server)

**VÃ­ dá»¥ (cho tÆ°Æ¡ng lai):**

```typescript
// constants/roles.ts
export const ROLES = {
  ADMIN: 'admin',
  USER: 'user',
  MODERATOR: 'moderator',
} as const;

export type Role = (typeof ROLES)[keyof typeof ROLES];

// constants/permissions.ts
export const PERMISSIONS = {
  CREATE_USER: 'create_user',
  DELETE_USER: 'delete_user',
  EDIT_USER: 'edit_user',
  VIEW_USERS: 'view_users',
} as const;

export type Permission = (typeof PERMISSIONS)[keyof typeof PERMISSIONS];

// lib/auth/permissions.ts
import { redirect } from 'next/navigation';
import { ROUTES } from '@/constants/routes';
import { ROLES, type Role } from '@/constants/roles';
import type { User } from '@supabase/supabase-js';

export const requireAdmin = (user: User) => {
  if (user.role !== ROLES.ADMIN) {
    redirect(ROUTES.DASHBOARD);
  }
};

export const requireRole = (user: User, allowedRoles: Role[]) => {
  if (!allowedRoles.includes(user.role as Role)) {
    redirect(ROUTES.DASHBOARD);
  }
};

// Usage trong page
const AdminPage = async () => {
  const user = await requireAuth();
  requireAdmin(user); // Check permission
  
  return <div>Admin content</div>;
};

// Usage vá»›i multiple roles
const ModeratorPage = async () => {
  const user = await requireAuth();
  requireRole(user, [ROLES.ADMIN, ROLES.MODERATOR]);
  
  return <div>Moderator content</div>;
};
```

**âš ï¸ LÆ°u Ã½:**
- âœ… Táº¥t cáº£ roles, permissions, status, enum values â†’ DÃ¹ng constants
- âœ… KhÃ´ng hardcode string literals nhÆ° `'admin'`, `'active'`, etc.
- âœ… DÃ¹ng `as const` Ä‘á»ƒ type safety
- âœ… Export types tá»« constants Ä‘á»ƒ reuse

---

## 5ï¸âƒ£ AUTH HOOK (use-auth â€“ CHá»T)

**File:** `hooks/use-auth.ts`

```typescript
'use client';

import { useRouter } from 'next/navigation';
import { supabaseClient } from '@/lib/supabase/client';
import { ROUTES } from '@/constants/routes';

export const useAuth = () => {
  const router = useRouter();

  const signInWithGoogle = async () => {
    await supabaseClient.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${location.origin}/auth/callback`,
      },
    });
  };

  const signOut = async () => {
    await supabaseClient.auth.signOut();
    router.push(ROUTES.LOGIN);
  };

  return {
    signInWithGoogle,
    signOut,
  };
};
```

**Rule:** Táº¥t cáº£ authentication logic pháº£i thÃ´ng qua hook nÃ y, khÃ´ng gá»i trá»±c tiáº¿p Supabase auth trong components.

---

## 6ï¸âƒ£ USERS TYPES (Báº®T BUá»˜C RIÃŠNG)

**File:** `types/users.types.ts`

```typescript
export interface User {
  id: string;
  email: string;
  full_name: string | null;
  created_at: string;
}
```

**Rule:** 
- âŒ KHÃ”NG Ä‘Æ°á»£c viáº¿t types/interfaces trong file service
- âœ… Báº®T BUá»˜C tÃ¡ch riÃªng file `*.types.ts` trong folder `types/`
- âœ… Táº¥t cáº£ types/interfaces pháº£i náº±m trong `types/`
- âœ… Import types tá»« `@/types/{feature}.types.ts` khi cáº§n

---

## 7ï¸âƒ£ USERS SERVICE â€“ SERVER SIDE

**File:** `services/users/users.service.ts`

```typescript
import { createSupabaseServerClient } from '@/lib/supabase/server';
import { User } from '@/types/users.types';

export const getUsersService = async (): Promise<User[]> => {
  const supabase = createSupabaseServerClient();

  const { data, error } = await supabase
    .from('users')
    .select('id, email, full_name, created_at'); // âœ… Select cá»¥ thá»ƒ columns

  if (error) {
    // âš ï¸ LÆ°u Ã½: Service throw lÃ  OK khi Ä‘Æ°á»£c gá»i tá»« Server Component
    // Next.js cÃ³ error boundary tá»± Ä‘á»™ng Ä‘á»ƒ handle. Náº¿u muá»‘n dÃ¹ng Result pattern,
    // cÃ³ thá»ƒ refactor sau: return err({ code: ERROR_CODES.DB_ERROR, message: error.message })
    throw new Error(error.message);
  }

  return data ?? [];
};
```

**Rule:**
- Chá»‰ chá»©a logic database
- KhÃ´ng chá»©a types/interfaces
- Import types tá»« `@/types/{feature}.types.ts`
- Chá»‰ dÃ¹ng `createSupabaseServerClient()`
- **Service throw Error lÃ  OK** khi Ä‘Æ°á»£c gá»i tá»« Server Component (Next.js error boundary handle)
- **Æ¯u tiÃªn Result pattern** (`return err(...)`) khi service cÃ³ thá»ƒ dÃ¹ng á»Ÿ nhiá»u context

---

## 8ï¸âƒ£ USERS SERVICE â€“ CLIENT SIDE

**File:** `services/users/users.client.ts`

```typescript
import { supabaseClient } from '@/lib/supabase/client';
import { User } from '@/types/users.types';

export const getUsersClientService = async (): Promise<User[]> => {
  const { data, error } = await supabaseClient
    .from('users')
    .select('id, email, full_name, created_at'); // âœ… Select cá»¥ thá»ƒ columns

  if (error) {
    throw error;
  }

  return data ?? [];
};
```

**Rule:**
- Chá»‰ dÃ¹ng cho client-side fetching (React Query, useEffect, etc.)
- KhÃ´ng chá»©a types/interfaces
- Import types tá»« `@/types/{feature}.types.ts`
- Chá»‰ dÃ¹ng `supabaseClient`

---

## 9ï¸âƒ£ SERVER COMPONENT (PAGE)

**File:** `app/(dashboard)/users/page.tsx`

```typescript
import { getUsersService } from '@/services/users/users.service';
import UsersTable from '@/components/users-table.client';

const UsersPage = async () => {
  const users = await getUsersService();

  return <UsersTable users={users} />;
};

export default UsersPage;
```

**Rule:**
- âŒ KhÃ´ng gá»i Supabase trá»±c tiáº¿p
- âŒ KhÃ´ng query database trá»±c tiáº¿p
- âœ… Chá»‰ gá»i service
- âœ… Pass data xuá»‘ng Client Component

---

## ğŸ”Ÿ CLIENT COMPONENT

**File:** `components/users-table.client.tsx`

```typescript
'use client';

import { User } from '@/types/users.types';

type Props = {
  users: User[];
};

const UsersTable = ({ users }: Props) => {
  return (
    <ul>
      {users.map((u) => (
        <li key={u.id}>{u.email}</li>
      ))}
    </ul>
  );
};

export default UsersTable;
```

**Rule:**
- âŒ KhÃ´ng gá»i Supabase trá»±c tiáº¿p
- âœ… Nháº­n data tá»« props hoáº·c React Query
- âœ… Import types tá»« `@/types/{feature}.types.ts`
- âœ… Äáº·t trong folder `components/` nhÆ° cáº¥u trÃºc hiá»‡n táº¡i

---

## 1ï¸âƒ£1ï¸âƒ£ REACT QUERY (CLIENT FETCH)

**File:** `features/users/queries/use-users.query.ts`

```typescript
'use client';

import { useQuery } from '@tanstack/react-query';
import { getUsersClientService } from '@/services/users/users.client';

export const useUsersQuery = () =>
  useQuery({
    queryKey: ['users'],
    queryFn: getUsersClientService,
  });
```

**Rule:**
- DÃ¹ng cho client-side data fetching
- Gá»i client service, khÃ´ng gá»i Supabase trá»±c tiáº¿p
- Äáº·t trong folder `features/{feature}/queries/`
- Chá»‰ chá»©a queries vÃ  actions, khÃ´ng chá»©a components

---

## 1ï¸âƒ£2ï¸âƒ£ ZOD VALIDATION â€“ Báº®T BUá»˜C á»Ÿ Action Layer

**ğŸ”’ RULE Cá»¨NG:**
- âŒ **Service KHÃ”NG validate input**
- âœ… **Server Action Báº®T BUá»˜C dÃ¹ng Zod Ä‘á»ƒ validate input**

**LÃ½ do:**
- TÃ¡ch biá»‡t validation logic vÃ  database logic
- Service cÃ³ thá»ƒ dÃ¹ng láº¡i á»Ÿ nhiá»u context (khÃ´ng chá»‰ tá»« Action)
- Zod cung cáº¥p type-safe validation vá»›i TypeScript
- Action layer lÃ  boundary giá»¯a client vÃ  server â†’ cáº§n validate cháº·t cháº½

**Cáº¥u trÃºc:**
```typescript
// features/users/actions/create-user.schema.ts
import { z } from 'zod';

export const CreateUserSchema = z.object({
  email: z.string().email('Invalid email address'),
  full_name: z.string().min(1, 'Full name is required'),
});

export type CreateUserInput = z.infer<typeof CreateUserSchema>;
```

**VÃ­ dá»¥ Action:**
```typescript
// features/users/actions/create-user.action.ts
'use server';

import { CreateUserSchema } from './create-user.schema';
import { createUserService } from '@/services/users/users.service';
import { revalidatePath } from 'next/cache';

export const createUserAction = async (formData: FormData) => {
  // âœ… Báº®T BUá»˜C: Validate input vá»›i Zod trÆ°á»›c khi gá»i service
  const rawInput = {
    email: formData.get('email'),
    full_name: formData.get('full_name'),
  };

  // Zod parse sáº½ throw ZodError náº¿u invalid
  const input = CreateUserSchema.parse(rawInput);

  // Service KHÃ”NG validate â†’ chá»‰ lÃ m database operation
  const user = await createUserService(input);

  revalidatePath('/users');
  return { success: true, data: user };
};
```

**VÃ­ dá»¥ Action vá»›i error handling:**
```typescript
// features/users/actions/create-user.action.ts
'use server';

import { CreateUserSchema } from './create-user.schema';
import { createUserService } from '@/services/users/users.service';
import { ZodError } from 'zod';

export const createUserAction = async (formData: FormData) => {
  try {
    const rawInput = {
      email: formData.get('email'),
      full_name: formData.get('full_name'),
    };

    // Validate vá»›i Zod
    const input = CreateUserSchema.parse(rawInput);

    // Service khÃ´ng validate â†’ chá»‰ lÃ m DB operation
    const user = await createUserService(input);

    return { success: true, data: user };
  } catch (error) {
    // Handle Zod validation errors
    if (error instanceof ZodError) {
      return {
        success: false,
        error: error.errors.map((e) => `${e.path.join('.')}: ${e.message}`).join(', '),
      };
    }

    // Handle service errors
    return { success: false, error: 'Failed to create user' };
  }
};
```

**Service KHÃ”NG validate:**
```typescript
// services/users/users.service.ts
import { createSupabaseServerClient } from '@/lib/supabase/server';
import { User } from '@/types/users.types';
import type { CreateUserInput } from '@/features/users/actions/create-user.schema';

// âœ… ÄÃšNG - Service KHÃ”NG validate input, chá»‰ lÃ m DB operation
export const createUserService = async (input: CreateUserInput): Promise<User> => {
  const supabase = createSupabaseServerClient();

  // Input Ä‘Ã£ Ä‘Æ°á»£c validate á»Ÿ Action layer â†’ khÃ´ng cáº§n validate láº¡i
  const { data, error } = await supabase
    .from('users')
    .insert(input)
    .select('id, email, full_name, created_at') // âœ… Select cá»¥ thá»ƒ columns
    .single();

  if (error) {
    throw new Error(error.message);
  }

  return data;
};
```

**âŒ SAI - Service validate input:**
```typescript
// âŒ SAI - Service khÃ´ng Ä‘Æ°á»£c validate input
export const createUserService = async (input: CreateUserInput) => {
  // âŒ KHÃ”NG Ä‘Æ°á»£c validate á»Ÿ Ä‘Ã¢y
  if (!input.email || !input.email.includes('@')) {
    throw new Error('Invalid email');
  }

  // ...
};
```

**Rule:**
- âœ… **Action layer:** Báº®T BUá»˜C dÃ¹ng Zod Ä‘á»ƒ validate input tá»« formData/client
- âœ… **Schema file:** Äáº·t trong `features/{feature}/actions/{action}.schema.ts`
- âœ… **Type inference:** DÃ¹ng `z.infer<typeof Schema>` Ä‘á»ƒ generate TypeScript type
- âŒ **Service layer:** KHÃ”NG validate input, chá»‰ lÃ m database operation
- âœ… **Error handling:** Action catch ZodError vÃ  return user-friendly message

---

## 1ï¸âƒ£3ï¸âƒ£ SERVER ACTIONS â€“ Æ¯U TIÃŠN THAY API ROUTES

**Rule:** Æ¯u tiÃªn Server Actions thay vÃ¬ API routes cho form submissions vÃ  mutations

**LÃ½ do:**
- Server Actions tá»± Ä‘á»™ng handle CSRF protection
- Ãt JavaScript bundle (khÃ´ng cáº§n API route code)
- Dá»… cache vÃ  revalidate
- Type-safe vá»›i TypeScript
- TÃ­ch há»£p tá»‘t vá»›i forms (`<form action={action}>`)

**Khi nÃ o dÃ¹ng Server Actions:**
- âœ… Form submissions (create, update, delete)
- âœ… Mutations tá»« client components
- âœ… Actions khÃ´ng cáº§n public API endpoint
- âœ… Actions chá»‰ dÃ¹ng trong app (khÃ´ng expose cho third-party)

**Khi nÃ o váº«n cáº§n API Routes:**
- âœ… Webhooks (cáº§n public endpoint)
- âœ… Third-party integrations (OAuth callbacks, payment webhooks)
- âœ… Public API endpoints (cho mobile apps, external services)
- âœ… File uploads vá»›i multipart/form-data (cÃ³ thá»ƒ dÃ¹ng Server Actions nhÆ°ng API route Ä‘Æ¡n giáº£n hÆ¡n)

**VÃ­ dá»¥ Server Actions:**
```typescript
// âœ… ÄÃšNG - Server Action cho form submission
// features/users/actions/create-user.action.ts
'use server';

import { CreateUserSchema } from './create-user.schema';
import { createUserService } from '@/services/users/users.service';
import { revalidatePath } from 'next/cache';

export const createUserAction = async (formData: FormData) => {
  const rawInput = {
    email: formData.get('email'),
    full_name: formData.get('full_name'),
  };

  const input = CreateUserSchema.parse(rawInput);
  const user = await createUserService(input);
  
  revalidatePath('/users');
  return { success: true, data: user };
};

// âœ… ÄÃšNG - DÃ¹ng trong form
'use client';

import { createUserAction } from '@/features/users/actions/create-user.action';

export function CreateUserForm() {
  return (
    <form action={createUserAction}>
      <input name="email" type="email" />
      <input name="full_name" type="text" />
      <button type="submit">Create User</button>
    </form>
  );
}
```

**VÃ­ dá»¥ API Route (khi cáº§n):**
```typescript
// âœ… ÄÃšNG - API Route cho webhook
// app/api/webhooks/stripe/route.ts
import { headers } from 'next/headers';

export async function POST(request: Request) {
  const signature = headers().get('stripe-signature');
  // Verify webhook signature
  // Process webhook
  return Response.json({ received: true });
}
```

**Lá»£i Ã­ch Server Actions:**
- âœ… **Auto CSRF:** Next.js tá»± Ä‘á»™ng protect
- âœ… **Ãt JS:** KhÃ´ng cáº§n fetch code á»Ÿ client
- âœ… **Type-safe:** TypeScript types tá»± Ä‘á»™ng
- âœ… **Easy revalidation:** DÃ¹ng `revalidatePath()` / `revalidateTag()`
- âœ… **Form integration:** `<form action={action}>` Ä‘Æ¡n giáº£n

**Guidelines:**
- âœ… **Æ¯u tiÃªn Server Actions** cho form submissions vÃ  mutations
- âœ… **DÃ¹ng API Routes** chá»‰ khi cáº§n public endpoint hoáº·c webhooks
- âœ… **Server Actions** cho internal app actions
- âœ… **API Routes** cho external integrations

---

### âŒ KHÃ”NG ÄÆ¯á»¢C LÃ€M

1. âŒ **Component gá»i Supabase trá»±c tiáº¿p**
   - Component khÃ´ng Ä‘Æ°á»£c import vÃ  sá»­ dá»¥ng `supabaseClient` hoáº·c `createSupabaseServerClient`
   - Pháº£i thÃ´ng qua service hoáº·c hook

2. âŒ **Server Component query DB trá»±c tiáº¿p**
   - Server Component khÃ´ng Ä‘Æ°á»£c query database trá»±c tiáº¿p
   - Pháº£i gá»i service

3. âŒ **Hardcode route**
   - KhÃ´ng Ä‘Æ°á»£c hardcode Ä‘Æ°á»ng dáº«n nhÆ° `'/login'`, `'/dashboard'`
   - Pháº£i dÃ¹ng `ROUTES` tá»« `@/constants/routes`

4. âŒ **Type / Interface náº±m chung file service hoáº·c trong folder services/**
   - KhÃ´ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a types/interfaces trong file service
   - KhÃ´ng Ä‘Æ°á»£c Ä‘áº·t file `*.types.ts` trong folder `services/` hoáº·c `features/`
   - Pháº£i tÃ¡ch riÃªng file `*.types.ts` trong folder `types/`

5. âŒ **Service validate input**
   - Service KHÃ”NG Ä‘Æ°á»£c validate input
   - Validation pháº£i á»Ÿ Action layer vá»›i Zod
   - Service chá»‰ lÃ m database operation

6. âŒ **Service gá»i service khÃ¡c**
   - Service KHÃ”NG Ä‘Æ°á»£c gá»i service khÃ¡c
   - Chá»‰ Feature/Action layer Ä‘Æ°á»£c orchestration
   - Service = atomic DB operation

7. âŒ **DÃ¹ng `.select('*')`**
   - KHÃ”NG Ä‘Æ°á»£c dÃ¹ng `.select('*')` trong Supabase query
   - PHáº¢I select cá»¥ thá»ƒ columns cáº§n thiáº¿t
   - TrÃ¡nh leak sensitive fields vÃ  improve performance

8. âŒ **Client Service throw raw Supabase error**
   - Client Service KHÃ”NG Ä‘Æ°á»£c throw raw Supabase error object
   - PHáº¢I throw Error Ä‘Ã£ map hoáº·c dÃ¹ng Result pattern
   - TrÃ¡nh leak sensitive details (table names, column names, etc.)

9. âŒ **DÃ¹ng `process.env` trá»±c tiáº¿p**
   - KHÃ”NG Ä‘Æ°á»£c dÃ¹ng `process.env.XYZ` trá»±c tiáº¿p trong code (trá»« `config/env.ts`)
   - PHáº¢I wrap qua `config/env.ts` vá»›i Zod validation
   - TrÃ¡nh crash production vÃ¬ thiáº¿u env variables

10. âŒ **Sá»­ dá»¥ng `any` type**
   - KhÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng `any` type trá»« trÆ°á»ng há»£p báº¥t kháº£ khÃ¡ng
   - Pháº£i dÃ¹ng `unknown` hoáº·c Ä‘á»‹nh nghÄ©a type cá»¥ thá»ƒ
   - Náº¿u báº¯t buá»™c dÃ¹ng `any`, pháº£i cÃ³ comment giáº£i thÃ­ch lÃ½ do

11. âŒ **Type assertion phá»©c táº¡p: `as unknown as T`, `(x as any).field`**
   - KHÃ”NG dÃ¹ng `(profile as unknown as { role?: {...} }).role` â€“ khÃ³ Ä‘á»c, dá»… sai
   - KHÃ”NG dÃ¹ng `(obj as any).field` â€“ máº¥t type safety
   - PHáº¢I táº¡o helper function hoáº·c type guard trong `lib/` (VD: `getRoleCode()` trong `lib/profile-utils.ts`)
   - DÃ¹ng type narrowing qua runtime check (typeof, in, v.v.) thay vÃ¬ assertion phá»©c táº¡p
   - VÃ­ dá»¥: Profile cÃ³ `role` tá»« API (object/array/string) â†’ dÃ¹ng `getRoleCode(profile)` thay vÃ¬ assertion inline

12. âŒ **Äáº·t file markdown documentation á»Ÿ root hoáº·c folder khÃ¡c**
   - KHÃ”NG Ä‘Æ°á»£c Ä‘áº·t file `.md` documentation á»Ÿ root directory (trá»« `README.md`)
   - KHÃ”NG Ä‘Æ°á»£c Ä‘áº·t file `.md` trong cÃ¡c folder khÃ¡c nhÆ° `components/`, `services/`, etc.
   - PHáº¢I Ä‘áº·t táº¥t cáº£ file markdown documentation trong folder `docs/`
   - GiÃºp dá»… quáº£n lÃ½ vÃ  tá»• chá»©c documentation

### âœ… PHáº¢I LÃ€M

1. âœ… **Service = DB only**
   - Service chá»‰ chá»©a logic database
   - KhÃ´ng chá»©a business logic phá»©c táº¡p
   - KhÃ´ng chá»©a types/interfaces

2. âœ… **Types = `types/*.types.ts`**
   - Táº¥t cáº£ types/interfaces pháº£i náº±m trong folder `types/`
   - File format: `types/{feature}.types.ts`
   - Import types tá»« `@/types/{feature}.types.ts` khi cáº§n

3. âœ… **Navigation = ROUTES**
   - Táº¥t cáº£ navigation pháº£i dÃ¹ng `ROUTES` tá»« `@/constants/routes`
   - KhÃ´ng hardcode Ä‘Æ°á»ng dáº«n

4. âœ… **Auth = use-auth**
   - Táº¥t cáº£ authentication logic pháº£i thÃ´ng qua `useAuth()` hook
   - KhÃ´ng gá»i Supabase auth trá»±c tiáº¿p trong components

5. âœ… **Zod Validation á»Ÿ Action Layer**
   - Server Action Báº®T BUá»˜C dÃ¹ng Zod Ä‘á»ƒ validate input
   - Schema file: `features/{feature}/actions/{action}.schema.ts`
   - Service KHÃ”NG validate input, chá»‰ lÃ m database operation
   - DÃ¹ng `z.infer<typeof Schema>` Ä‘á»ƒ generate TypeScript type

6. âœ… **Service Boundary**
   - Service chá»‰ lÃ m atomic DB operation
   - Service KHÃ”NG gá»i service khÃ¡c
   - Feature/Action layer orchestrate nhiá»u services

7. âœ… **Select Columns cá»¥ thá»ƒ**
   - PHáº¢I select cá»¥ thá»ƒ columns: `.select('id, email, full_name')`
   - KHÃ”NG dÃ¹ng `.select('*')`
   - TrÃ¡nh leak sensitive fields, improve performance

8. âœ… **Client Service Error Handling**
   - Throw Error Ä‘Ã£ map: `throw new Error('FAILED_TO_FETCH_USERS')`
   - Hoáº·c dÃ¹ng Result pattern: `return err(createError.database('FETCH_USERS_FAILED'))`
   - KHÃ”NG throw raw Supabase error object

9. âœ… **ENV & CONFIG Management**
   - Táº¥t cáº£ env variables pháº£i Ä‘á»‹nh nghÄ©a trong `config/env.ts`
   - DÃ¹ng Zod validation Ä‘á»ƒ Ä‘áº£m báº£o env há»£p lá»‡
   - Import tá»« `@/config/env` khi cáº§n dÃ¹ng env
   - KHÃ”NG dÃ¹ng `process.env` trá»±c tiáº¿p (trá»« `config/env.ts`)

10. âœ… **UI Components = HeroUI First**

**File:** `services/users/users.client.ts`

**ğŸ”’ RULE Cá»¨NG:**
- âŒ **KHÃ”NG throw raw Supabase error object**
- âœ… **Throw Error Ä‘Ã£ map** hoáº·c **dÃ¹ng Result pattern**

**LÃ½ do:**
- TrÃ¡nh leak sensitive details tá»« Supabase error
- ÄÃºng vá»›i triáº¿t lÃ½ error handling (khÃ´ng expose internal error structure)
- Error message cÃ³ thá»ƒ chá»©a thÃ´ng tin nháº¡y cáº£m (table names, column names, etc.)

**VÃ­ dá»¥:**
```typescript
import { supabaseClient } from '@/lib/supabase/client';
import { User } from '@/types/users.types';

// âœ… ÄÃšNG - Throw Error Ä‘Ã£ map (khÃ´ng leak detail)
export const getUsersClientService = async (): Promise<User[]> => {
  const { data, error } = await supabaseClient
    .from('users')
    .select('id, email, full_name, created_at'); // âœ… Select cá»¥ thá»ƒ columns

  if (error) {
    // âœ… Throw Error Ä‘Ã£ map, khÃ´ng throw raw Supabase error
    throw new Error('FAILED_TO_FETCH_USERS');
  }

  return data ?? [];
};

// âœ… ÄÃšNG - DÃ¹ng Result pattern (náº¿u dÃ¹ng vá»›i React Query error handling)
import { Result, ok, err } from '@/types/result.types';
import { createError } from '@/lib/errors';

export const getUsersClientService = async (): Promise<Result<User[]>> => {
  const { data, error } = await supabaseClient
    .from('users')
    .select('id, email, full_name, created_at');

  if (error) {
    // âœ… Return Result vá»›i error Ä‘Ã£ map
    return err(createError.database('FETCH_USERS_FAILED'));
  }

  return ok(data ?? []);
};

// âŒ SAI - Throw raw Supabase error (leak detail)
export const getUsersClientService = async (): Promise<User[]> => {
  const { data, error } = await supabaseClient
    .from('users')
    .select('id, email, full_name, created_at');

  if (error) {
    throw error; // âŒ KHÃ”NG Ä‘Æ°á»£c throw raw Supabase error
  }

  return data ?? [];
};
```

**Rule:**
- Chá»‰ dÃ¹ng cho client-side fetching (React Query, useEffect, etc.)
- KhÃ´ng chá»©a types/interfaces
- Import types tá»« `@/types/{feature}.types.ts`
- Chá»‰ dÃ¹ng `supabaseClient`
- âŒ **KHÃ”NG throw raw Supabase error** â†’ TrÃ¡nh leak detail
- âœ… **Throw Error Ä‘Ã£ map** hoáº·c **dÃ¹ng Result pattern**

---

## 9ï¸âƒ£ SERVER COMPONENT (PAGE)

**VÃ­ dá»¥:**
```typescript
// âœ… ÄÃšNG - Sá»­ dá»¥ng HeroUI components
import { Button } from '@heroui/button';
import { Input } from '@heroui/input';
import { Card, CardBody, CardHeader } from '@heroui/card';
import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from '@heroui/table';

const UserForm = () => {
  return (
    <Card>
      <CardHeader>Create User</CardHeader>
      <CardBody>
        <Input label="Email" />
        <Input label="Name" />
        <Button color="primary">Submit</Button>
      </CardBody>
    </Card>
  );
};

// âŒ SAI - Táº¡o custom component khi HeroUI Ä‘Ã£ cÃ³
import { Button as CustomButton } from '@/components/custom-button'; // âŒ
```

**Khi nÃ o Ä‘Æ°á»£c táº¡o custom component:**
- âœ… HeroUI khÃ´ng cÃ³ component tÆ°Æ¡ng á»©ng
- âœ… Cáº§n logic business phá»©c táº¡p khÃ´ng thá»ƒ wrap HeroUI component
- âœ… Cáº§n component composite (káº¿t há»£p nhiá»u HeroUI components)

9. âœ… **Type Safety = Use Types, Avoid `any` & Complex Assertions**
   - LuÃ´n Ä‘á»‹nh nghÄ©a type cá»¥ thá»ƒ cho variables, functions, props
   - Sá»­ dá»¥ng `type` hoáº·c `interface` thay vÃ¬ `any`
   - DÃ¹ng `unknown` náº¿u chÆ°a biáº¿t type chÃ­nh xÃ¡c
   - **TrÃ¡nh type assertion phá»©c táº¡p** (`as unknown as T`, `(x as any).field`) â†’ táº¡o helper/type guard trong `lib/`
   - Import types tá»« `@/types/{feature}.types.ts`

**VÃ­ dá»¥:**
```typescript
// âœ… ÄÃšNG - Sá»­ dá»¥ng type cá»¥ thá»ƒ
import { User } from '@/types/users.types';

type Props = {
  user: User;
  onUpdate: (user: User) => void;
};

const UserCard = ({ user, onUpdate }: Props) => {
  return <div>{user.email}</div>;
};

// âœ… ÄÃšNG - DÃ¹ng unknown khi chÆ°a biáº¿t type
const parseData = (data: unknown): User => {
  if (typeof data === 'object' && data !== null && 'email' in data) {
    return data as User;
  }
  throw new Error('Invalid user data');
};

// âŒ SAI - Sá»­ dá»¥ng any
const handleData = (data: any) => { // âŒ
  return data.email;
};

// âŒ SAI - KhÃ´ng cÃ³ type
const UserCard = ({ user, onUpdate }) => { // âŒ
  return <div>{user.email}</div>;
};

// âœ… ÄÃšNG - Type cho function parameters vÃ  return
type CreateUserInput = {
  email: string;
  full_name: string;
};

export const createUserService = async (
  input: CreateUserInput
): Promise<User> => {
  // Implementation
};

// âœ… ÄÃšNG - Type cho event handlers
const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
  e.preventDefault();
  // ...
};

// âœ… ÄÃšNG - Type cho generic functions
const fetchData = async <T>(url: string): Promise<T> => {
  const response = await fetch(url);
  return response.json();
};
```

**Best Practices:**
- âœ… LuÃ´n type props cá»§a components
- âœ… Type function parameters vÃ  return values
- âœ… Type event handlers (React.FormEvent, React.MouseEvent, etc.)
- âœ… Sá»­ dá»¥ng generic types khi cáº§n (`<T>`)
- âœ… DÃ¹ng `as const` cho literal types
- âœ… DÃ¹ng utility types (Partial, Pick, Omit, etc.)

10. âœ… **Documentation Files = `docs/` Folder**
   - Táº¥t cáº£ file markdown documentation pháº£i Ä‘áº·t trong folder `docs/`
   - File format: `docs/{document-name}.md`
   - KHÃ”NG Ä‘áº·t file `.md` á»Ÿ root directory (trá»« `README.md`)
   - GiÃºp dá»… quáº£n lÃ½ vÃ  tá»• chá»©c documentation

**VÃ­ dá»¥:**
```typescript
// âœ… ÄÃšNG - File markdown trong docs/
docs/PERFORMANCE_OPTIMIZATIONS.md
docs/api-reference.md
docs/deployment.md

// âŒ SAI - File markdown á»Ÿ root hoáº·c folder khÃ¡c
PERFORMANCE_OPTIMIZATIONS.md  // âŒ KHÃ”NG Ä‘Æ°á»£c Ä‘áº·t á»Ÿ root
components/README.md           // âŒ KHÃ”NG Ä‘Æ°á»£c Ä‘áº·t trong components/
```

---

## ğŸ“ CÃC FOLDER HIá»†N CÃ“ VÃ€ CÃCH TÃCH Há»¢P

### âœ… `components/` - All Components
**Má»¥c Ä‘Ã­ch:** Chá»©a Táº¤T Cáº¢ components cá»§a app (shared vÃ  feature-specific)

**Rule:**
- âœ… Táº¥t cáº£ components Ä‘á»u náº±m trong `components/`
- âœ… KhÃ´ng cÃ³ folder `components/` trong `features/`
- âŒ KhÃ´ng gá»i Supabase trá»±c tiáº¿p trong components
- âœ… Import types tá»« `@/types/{feature}.types.ts`
- âœ… Client Components pháº£i cÃ³ suffix `.client.tsx` hoáº·c `'use client'` directive
- âœ… **Æ¯u tiÃªn sá»­ dá»¥ng HeroUI components** (`@heroui/*`) trÆ°á»›c khi táº¡o custom component

**Cáº¥u trÃºc:**
```typescript
components/
â”œâ”€â”€ navbar.tsx                    # Shared layout component
â”œâ”€â”€ theme-switch.tsx              # Shared utility component
â”œâ”€â”€ icons.tsx                     # Shared icons
â”œâ”€â”€ users-table.client.tsx        # Feature-specific component
â”œâ”€â”€ user-form.client.tsx          # Feature-specific component
â””â”€â”€ products-list.client.tsx       # Feature-specific component
```

**VÃ­ dá»¥:**
```typescript
// âœ… components/navbar.tsx - Shared, dÃ¹ng á»Ÿ nhiá»u nÆ¡i
// âœ… components/theme-switch.tsx - Shared utility
// âœ… components/users-table.client.tsx - Feature-specific
// âœ… components/user-form.client.tsx - Feature-specific
```

### âœ… `config/` - App Configuration
**Má»¥c Ä‘Ã­ch:** Chá»©a cÃ¡c file cáº¥u hÃ¬nh (fonts, site config, env, etc.)

**Rule:**
- âœ… Giá»¯ nguyÃªn cáº¥u trÃºc hiá»‡n táº¡i
- âœ… **Báº®T BUá»˜C:** Táº¥t cáº£ env variables pháº£i Ä‘á»‹nh nghÄ©a trong `config/env.ts` vá»›i Zod validation
- âœ… CÃ³ thá»ƒ thÃªm config má»›i nhÆ° `config/supabase.ts` náº¿u cáº§n

**Cáº¥u trÃºc:**
```typescript
config/
â”œâ”€â”€ fonts.ts          # Font configuration
â”œâ”€â”€ site.ts           # Site configuration
â””â”€â”€ env.ts            # NEW: Environment variables vá»›i Zod validation
```

### âœ… `types/` - All Types/Interfaces
**Má»¥c Ä‘Ã­ch:** Chá»©a Táº¤T Cáº¢ types/interfaces cá»§a app (global vÃ  feature-specific)

**Rule:**
- âœ… Types dÃ¹ng chung â†’ `types/index.ts`
- âœ… Types thuá»™c feature/service â†’ `types/{feature}.types.ts`
- âŒ KHÃ”NG Ä‘á»‹nh nghÄ©a types trong file service
- âŒ KHÃ”NG Ä‘áº·t types trong folder `services/` hoáº·c `features/`

**Cáº¥u trÃºc:**
```typescript
types/
â”œâ”€â”€ index.ts              # Global types (IconSvgProps, etc.)
â”œâ”€â”€ users.types.ts        # User-related types
â”œâ”€â”€ products.types.ts     # Product-related types
â””â”€â”€ auth.types.ts         # Auth-related types
```

**VÃ­ dá»¥ import:**
```typescript
// âœ… ÄÃšNG
import { User } from '@/types/users.types';
import { IconSvgProps } from '@/types';

// âŒ SAI
import { User } from '@/services/users/users.types';
import { User } from './users.types';  // trong service file
```

### âœ… `styles/` - Global Styles
**Má»¥c Ä‘Ã­ch:** Chá»©a CSS global vÃ  theme styles

**Rule:**
- âœ… Giá»¯ nguyÃªn cáº¥u trÃºc hiá»‡n táº¡i
- âœ… Import trong `app/layout.tsx`

### âœ… `app/` - Next.js App Router
**Má»¥c Ä‘Ã­ch:** Chá»©a routes, layouts, pages cá»§a Next.js

**Rule:**
- âœ… Server Components gá»i service, khÃ´ng query DB trá»±c tiáº¿p
- âœ… Client Components nháº­n data tá»« props hoáº·c React Query
- âœ… Sá»­ dá»¥ng route groups `(auth)`, `(dashboard)` Ä‘á»ƒ tá»• chá»©c
- âœ… DÃ¹ng `ROUTES` tá»« `@/constants/routes` cho navigation

**Cáº¥u trÃºc hiá»‡n táº¡i:**
```
app/
â”œâ”€â”€ (auth)/          # NEW: Auth routes
â”œâ”€â”€ (dashboard)/     # NEW: Protected routes
â”‚   â””â”€â”€ users/       # NEW: Feature pages
â”œâ”€â”€ about/           # EXISTING: Keep as is
â”œâ”€â”€ blog/            # EXISTING: Keep as is
â”œâ”€â”€ docs/            # EXISTING: Keep as is
â”œâ”€â”€ pricing/         # EXISTING: Keep as is
â”œâ”€â”€ layout.tsx       # EXISTING: Root layout
â”œâ”€â”€ page.tsx         # EXISTING: Home page
â”œâ”€â”€ providers.tsx    # EXISTING: App providers
â””â”€â”€ error.tsx        # EXISTING: Error boundary
```

### âœ… `public/` - Static Assets
**Má»¥c Ä‘Ã­ch:** Chá»©a cÃ¡c file tÄ©nh (images, icons, favicon, etc.)

**Rule:**
- âœ… Giá»¯ nguyÃªn cáº¥u trÃºc hiá»‡n táº¡i

### âœ… `docs/` - Documentation Files
**Má»¥c Ä‘Ã­ch:** Chá»©a Táº¤T Cáº¢ cÃ¡c file markdown documentation cá»§a project

**Rule:**
- âœ… **Báº®T BUá»˜C:** Táº¥t cáº£ file `.md` (markdown) documentation pháº£i Ä‘áº·t trong folder `docs/`
- âŒ **KHÃ”NG Ä‘Æ°á»£c Ä‘áº·t** file `.md` á»Ÿ root directory hoáº·c cÃ¡c folder khÃ¡c
- âœ… Bao gá»“m: README, guides, API reference, deployment docs, performance docs, etc.
- âœ… File `README.md` á»Ÿ root lÃ  exception (file README chÃ­nh cá»§a project)

**Cáº¥u trÃºc:**
```typescript
docs/
â”œâ”€â”€ README.md                    # Documentation index/overview
â”œâ”€â”€ INDEX.md                     # Documentation index
â”œâ”€â”€ api-reference.md            # API documentation
â”œâ”€â”€ database-schema.md          # Database schema docs
â”œâ”€â”€ deployment.md                # Deployment guide
â”œâ”€â”€ usage.md                     # Usage guide
â””â”€â”€ PERFORMANCE_OPTIMIZATIONS.md # Performance optimizations docs
```

**VÃ­ dá»¥:**
```typescript
// âœ… ÄÃšNG - File markdown trong docs/
docs/PERFORMANCE_OPTIMIZATIONS.md
docs/api-reference.md
docs/deployment.md

// âŒ SAI - File markdown á»Ÿ root
PERFORMANCE_OPTIMIZATIONS.md  // âŒ KHÃ”NG Ä‘Æ°á»£c Ä‘áº·t á»Ÿ root
components/README.md            // âŒ KHÃ”NG Ä‘Æ°á»£c Ä‘áº·t trong components/
```

**LÆ°u Ã½:**
- File `README.md` á»Ÿ root directory lÃ  exception vÃ  Ä‘Æ°á»£c phÃ©p giá»¯ láº¡i
- Táº¥t cáº£ cÃ¡c file documentation khÃ¡c pháº£i náº±m trong `docs/`

### âœ… `features/` - Feature Queries & Actions
**Má»¥c Ä‘Ã­ch:** Chá»©a React Query hooks vÃ  Server Actions cho tá»«ng feature

**Rule:**
- âœ… Chá»‰ chá»©a `queries/` vÃ  `actions/`
- âŒ KHÃ”NG chá»©a `components/` (components náº±m trong `components/`)
- âœ… Má»—i feature cÃ³ folder riÃªng: `features/{feature}/`

**Cáº¥u trÃºc:**
```typescript
features/
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ queries/
â”‚   â”‚   â””â”€â”€ use-users.query.ts
â”‚   â””â”€â”€ actions/
â”‚       â””â”€â”€ create-user.action.ts
â””â”€â”€ products/
    â”œâ”€â”€ queries/
    â”‚   â””â”€â”€ use-products.query.ts
    â””â”€â”€ actions/
        â””â”€â”€ create-product.action.ts
```

**VÃ­ dá»¥:**
```typescript
// âœ… features/users/queries/use-users.query.ts - React Query hook
// âœ… features/users/actions/create-user.action.ts - Server Action
// âŒ features/users/components/ - KHÃ”NG cÃ³ folder nÃ y
```

---

## ğŸ“‹ CHECKLIST KHI VIáº¾T CODE

- [ ] ÄÃ£ táº¡o file `types/{feature}.types.ts` riÃªng cho types/interfaces?
- [ ] Service khÃ´ng chá»©a types/interfaces?
- [ ] Types náº±m trong folder `types/` chá»© khÃ´ng pháº£i `services/`?
- [ ] Component khÃ´ng gá»i Supabase trá»±c tiáº¿p?
- [ ] Server Component chá»‰ gá»i service?
- [ ] ÄÃ£ dÃ¹ng `ROUTES` thay vÃ¬ hardcode?
- [ ] Auth logic thÃ´ng qua `useAuth()` hook?
- [ ] Client service dÃ¹ng `supabaseClient`?
- [ ] Server service dÃ¹ng `createSupabaseServerClient()`?
- [ ] Features chá»‰ chá»©a queries vÃ  actions, khÃ´ng cÃ³ components?
- [ ] Components náº±m trong folder `components/`?
- [ ] **Server Action Ä‘Ã£ dÃ¹ng Zod Ä‘á»ƒ validate input?**
- [ ] **Service KHÃ”NG validate input (validation á»Ÿ Action layer)?**
- [ ] **Service KHÃ”NG gá»i service khÃ¡c (chá»‰ Feature/Action orchestrate)?**
- [ ] **ÄÃ£ select cá»¥ thá»ƒ columns thay vÃ¬ `.select('*')`?**
- [ ] **Client Service KHÃ”NG throw raw Supabase error (throw Error Ä‘Ã£ map hoáº·c Result)?**
- [ ] **ÄÃ£ dÃ¹ng env tá»« `@/config/env` thay vÃ¬ `process.env` trá»±c tiáº¿p?**
- [ ] ÄÃ£ Æ°u tiÃªn sá»­ dá»¥ng HeroUI components trÆ°á»›c khi táº¡o custom component?
- [ ] KhÃ´ng sá»­ dá»¥ng `any` type (dÃ¹ng `unknown` hoáº·c type cá»¥ thá»ƒ)?
- [ ] **TrÃ¡nh type assertion phá»©c táº¡p** (`as unknown as T`, `(x as any).field`) â€“ dÃ¹ng helper/type guard?
- [ ] Táº¥t cáº£ props, functions, variables Ä‘Ã£ cÃ³ type?
- [ ] Import types tá»« `@/types/{feature}.types.ts`?
- [ ] Middleware Ä‘Ã£ implement route protection (redirect náº¿u Ä‘Ã£ login vÃ o auth routes, chÆ°a login vÃ o protected routes)?
- [ ] ÄÃ£ dÃ¹ng `getUser()` thay vÃ¬ `getSession()`?
- [ ] Chá»‰ dÃ¹ng `requireAuth()` khi cáº§n user object trong page (khÃ´ng cáº§n náº¿u chá»‰ check auth)?
- [ ] KhÃ´ng dÃ¹ng `redirectIfAuthenticated()` trong auth pages (middleware Ä‘Ã£ handle)?
- [ ] Route constants (PUBLIC_ROUTES, PROTECTED_ROUTES, AUTH_ROUTES) Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a?
- [ ] **File markdown documentation Ä‘Ã£ Ä‘áº·t trong folder `docs/` (khÃ´ng Ä‘áº·t á»Ÿ root)?**

---

## ğŸ¯ TÃ“M Táº®T

**Kiáº¿n trÃºc 3 táº§ng:**
1. **Services** â†’ Database layer (Supabase)
2. **Features** â†’ Business logic layer (Queries, Actions)
3. **Components + App** â†’ Presentation layer (Components, Pages, Layouts)

**NguyÃªn táº¯c:**
- Separation of concerns
- Single responsibility
- Type safety
- Reusability

